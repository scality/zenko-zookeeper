version: 2

noop: &noop
  docker:
    - image: busybox
  steps:
    - run: "true"

jobs:
  # Init phase
  pre_init:
    <<: *noop

  lint_commits:
    docker:
      - image: docker.io/alpine:3.6
    steps:
      # These should go in our own Docker image, no need to build every single time
      - run: apk add --no-cache nodejs nodejs-npm git
      - run: npm install -g @commitlint/cli @commitlint/config-conventional
      - checkout
      # Assume target branch is always 'master' :-/
      - run: commitlint --from master --to $CIRCLE_SHA1 -x "@commitlint/config-conventional"

  post_init:
    <<: *noop
  build:
    docker:
      - image: zenko/zenko-releng:0.0.4
    environment:
      - DOCKER_REGISTRY: "zempashi/"
        # zenko/ is equivalent to docker.io/zenko/ but
        # docker images docker.io/zenko/<image> doesn't work
        # (only docker images zenko/<image> works)
      - GITHUB_USER: 'zempashi'
      - RELEASE: '1'
    steps:
      - checkout
      - setup_remote_docker
      - run: |
          git config --global user.email "ci-zenko@scality.com"
          ssh-add /root/.ssh/id_rsa
          ssh-add -L | grep id_rsa > /root/.ssh/id_rsa.pub
          ssh-add -d /root/.ssh/id_rsa
        # Enable github push ability.
        # TODO(jgirardi): remove this hack
      - run: |
          if [ "$CIRCLE_BRANCH" == "master" ]; then
              export COMMIT=1
          fi
              make release
              cat build/env.sh
              echo '============'
              cat build/release.patch || true
      - run: make build-all
      - run: docker login --username zempashi --password ${DOCKER_PASS}
      - run: |
          if [ "$CIRCLE_BRANCH" == "master" ]; then
            make publish
          fi

workflows:
  version: 2
  pipeline:
    jobs:
      # Init phase
      - pre_init
      - lint_commits:
          requires:
            - pre_init
      - post_init:
          requires:
            - pre_init
            - lint_commits
      - build:
          requires:
            - post_init
